{% extends 'base.html' %}
{% load static %}
{% block title %}
  {{ tag }} List
{% endblock title %}

{% block content %}
<div class="tag--title">
  <h2>#{{ tag }}</h2>
</div>
{% if posts %}
  <div class="search--content">
    {% for post, image in post_images %}
    <a href="{% url 'posts:detail' post.pk %}" class="index--card">
      <div class="index--card--box">
        <div class="index--image--box">
          {% if image %}
            <img src="{{ image.image.url }}" alt="" class="index--img object-fit-fill">
          {% else %}
            <img src="{% static 'image/none_img.png' %}" alt=""  class="index--img object-fit-fill">
          {% endif %}
        </div>
        <div class="index--info--box ">
          <div class="index--title">
            {{ post.title }}
          </div>
          <div class="index--txt p-1">
            <p class="index--txt"> {{ post.address }}</p>
          </div>
          <div class="d-flex justify-content-between index--txt p-1">
            <p class="index--txt">{{ post.menu }}</p>
            <div class='d-flex gap-1'>
              {% if request.user.is_authenticated %}
                <form id="likes-form-{{ post.pk }}" data-post-id="{{ post.pk }}" class="index--heart">
                  {% csrf_token %}
                  {% if request.user in post.like_users.all %}
                      <button class="btn btn-link text-danger p-0" type="submit">
                        <i class="bi bi-suit-heart-fill"></i>
                      </button>
                  {% else %}
                      <button class="btn btn-link text-danger p-0" type="submit">
                        <i class="bi bi-suit-heart"></i>
                      </button>
                  {% endif %}
                </form>
              {% else %}
                <button class="btn btn-link text-secondary p-0" disabled>
                  <i class="bi bi-suit-heart"></i>
                </button>
              {% endif %}
              <span id="likes-count">{{ post.like_users.all|length }}</span>
            </div>
          </div>
        </div>
      </div>
    </a>
    {% endfor %}
  </div>
  <div>
    <ul class="pagination justify-content-center" style="grid-column: 2 / 4; grid-row: 2 / 3;">
      {% if post_images.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?q={{ query }}&page={{ post_images.previous_page_number }}">이전</a>
      </li>
      {% else %}
        <li class="page-item disabled">
          <a class="page-link" tabindex="-1" aria-disabled="true" href="#">이전</a>
        </li>
      {% endif %}

      {% for page_number in post_images.paginator.page_range %}
        {% if page_number >= post_images.number|add:-5 and page_number <= post_images.number|add:5 %}
          {% if page_number == post_images.number %}
            <li class="page-item active" aria-current="page">
              <a class="page-link" href="?q={{ query }}&page={{ page_number }}">{{ page_number }}</a>
            </li>
          {% else %}
            <li class="page-item">
              <a class="page-link" href="?q={{ query }}&page={{ page_number }}">{{ page_number }}</a>
            </li>
          {% endif %}
        {% endif %}
      {% endfor %}


      {% if post_images.has_next %}
        <li class="page-item">
          <a class="page-link" href="?q={{ query }}&page={{ post_images.next_page_number }}">다음</a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <a class="page-link" tabindex="-1" aria-disabled="true" href="#">다음</a>
        </li>
      {% endif %}
    </ul>
  </div>
{% else %}
  <div class="d-flex flex-column align-items-center justify-content-center" style="height: 500px">
    <img src="{% static 'image/empty.png' %}" alt="" style="height: 200px; width: 200px;">
    <h4>검색결과가 없습니다.</h4>
  </div>
{% endif %}
{% endblock content %}

{% block script %}
<script>
const forms = document.querySelectorAll('[id^="likes-form-"]');
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

forms.forEach(function (form) {
  form.addEventListener('submit', function (event) {
    event.preventDefault();
    const postId = event.target.dataset.postId;
    axios({
      method: 'post',
      url: `/posts/${postId}/likes/`,
      headers: {'X-CSRFToken': csrftoken},
    })
      .then((response) => {
        const isLiked = response.data.is_liked;
        const likesCountSpan = form.nextElementSibling;
        likesCountSpan.textContent = response.data.likes_count;
        const heartIcon = form.querySelector('i');
        if (isLiked) {
          heartIcon.classList.remove('bi-suit-heart');
          heartIcon.classList.add('bi-suit-heart-fill');
        } else {
          heartIcon.classList.remove('bi-suit-heart-fill');
          heartIcon.classList.add('bi-suit-heart');
        }
      })
      .catch((error) => {
        console.error(error);
      });
  });
});
</script>

{% endblock script %}